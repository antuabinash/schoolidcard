<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - ID Cards Pro</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding:20px; background:#f4f7f6; color:#222; }
    .container { max-width:1200px; margin:0 auto; }
    h1 { color:#0b53a0; margin-bottom: 20px; }
    
    .hidden { display: none !important; }
    .btn { padding:10px 15px; border-radius:6px; border:none; cursor:pointer; font-weight:600; color:white; }
    .btn-primary { background:#007bff; }
    .btn-success { background:#28a745; }
    .btn-danger { background:#dc3545; }
    .btn-warning { background:#ffc107; color:#222; }
    .btn-secondary { background:#6c757d; }
    input, select { padding:10px; border-radius:6px; border:1px solid #ccc; }

    /* Layouts */
    .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .school-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee; }
    .school-card:hover { transform: translateY(-3px); border-color: #007bff; }
    
    .detail-header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: start; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .hm-sign-img { height: 50px; border: 1px solid #ddd; margin-top: 5px; background: white; padding: 2px; }

    .status-badge { display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:bold; margin-left:5px; }
    .status-ok { background:#d4edda; color:#155724; }
    .status-err { background:#f8d7da; color:#721c24; }

    .config-panel { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #90caf9; display: flex; gap: 20px; align-items: center; flex-wrap:wrap; }
    
    .table-container { background: white; padding: 15px; border-radius: 12px; overflow-x: auto; }
    table { width:100%; border-collapse:collapse; font-size: 14px; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align: middle; }
    th { background:#f8f9fa; font-weight: 600; }
    img.thumb { width:35px; height:35px; border-radius:4px; object-fit: cover; border: 1px solid #ddd; }

    .action-bar { margin-top: 20px; padding: 20px; background: white; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; position: sticky; bottom: 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }

    /* Modals */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; }
    .modal-content { background:white; padding:25px; border-radius:8px; width:90%; max-width:400px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; box-sizing: border-box; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
  </style>
</head>
<body>

<div class="container">

  <div id="dashboardView">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1>Admin Dashboard</h1>
        <div>
            <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh Data</button>
            <button class="btn btn-warning" id="downloadRawBtn">üíæ Backup Data</button>
        </div>
    </div>
    <div id="schoolGrid" class="school-grid"><p>Loading...</p></div>
  </div>

  <div id="detailView" class="hidden">
    <button class="btn btn-secondary" onclick="showDashboard()" style="margin-bottom:15px;">‚Üê Back</button>
    
    <div class="detail-header">
        <div>
            <h2 id="viewSchoolName" style="color:#E85C0D; margin:0;">School Name</h2>
            <div id="viewAddress" style="color:#555; font-size:14px; margin-top:5px;"></div>
            <div id="viewContact" style="color:#0277bd; font-weight:bold; margin-top:5px;"></div>
        </div>
        <div style="text-align:right;">
            <small>HM Signature:</small><br>
            <img id="viewHmSign" class="hm-sign-img" src="" alt="No Sign">
        </div>
    </div>

    <div class="config-panel">
        <div>
            <label style="font-size:12px; font-weight:bold;">Background PNG</label><br>
            <input id="templateInput" type="file" accept="image/png">
            <span id="tplStatus" class="status-badge status-err">Missing</span>
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">Odia Font (.ttf)</label><br>
            <input id="fontInput" type="file" accept=".ttf,.otf">
            <span id="fontStatus" class="status-badge status-err">Missing</span>
        </div>
        <div style="flex:1; text-align:right;">
             <span id="aiStatus" style="font-style:italic;">‚è≥ AI Loading...</span>
        </div>
    </div>

    <div class="table-container">
        <table id="studentTable">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                    <th>#</th><th>Photo</th><th>Name</th><th>Class</th><th>Roll</th><th>DOB</th><th>Blood</th><th>Mobile</th><th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="action-bar">
        <span id="selectionCount">0 students selected</span>
        <button id="generateBtn" class="btn btn-success" disabled>üñ® Generate Automated ID Cards</button>
    </div>
  </div>
</div>

<canvas id="cardCanvas" style="display:none;"></canvas>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Edit Student</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>Class</label><input type="text" id="editClass"></div>
            <div class="form-group"><label>Roll</label><input type="text" id="editRoll"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>DOB</label><input type="date" id="editDob"></div>
            <div class="form-group"><label>Blood</label><select id="editBlood"><option value="">-</option><option value="A+">A+</option><option value="B+">B+</option><option value="O+">O+</option><option value="AB+">AB+</option></select></div>
        </div>
        <div class="form-group"><label>Mobile</label><input type="text" id="editPhone"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
            <button class="btn btn-primary" id="saveEditBtn">Save</button>
        </div>
    </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const DPI = 300;
const CARD_W = 638;  // 54mm @ 300dpi
const CARD_H = 1012; // 85.6mm @ 300dpi
const A4_W = 3508, A4_H = 2480;

// Coordinate Configuration
// School Name Area: 119 to 611 px. Center = 365px.
const HEADER_MIN_X = 119;
const HEADER_MAX_X = 611;
const HEADER_CENTER_X = 365;
const HEADER_Y = 57;

// Address Area: 198, 94
const ADDR_X = 198;
const ADDR_Y = 94;

// Signature: 434, 881
const SIGN_X = 434;
const SIGN_Y = 881;
const SIGN_MAX_W = 180;
const SIGN_MAX_H = 60;

/* ---------- HELPERS ---------- */
window.odiaDigits = ['‡≠¶','‡≠ß','‡≠®','‡≠©','‡≠™','‡≠´','‡≠¨','‡≠≠','‡≠Æ','‡≠Ø'];
function toOdiaDigits(str){ if (str===undefined||str===null) return ''; return (''+str).replace(/\d/g,d=>window.odiaDigits[d]||d); }
function escapeHtml(s){ return (s+'').replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

/* ---------- STATE ---------- */
let db = null;
let allStudents = [];
let schoolsMap = {};
let currentSchoolStudents = [];
window.assets = { template: null, font: null, aiModel: 'pending', mode: 'manual' }; 

/* ---------- AUTO-LOAD ASSETS ---------- */
async function loadAutoAssets() {
    try {
        const resp = await fetch('OdiaFont.ttf');
        if(resp.ok) {
            const buf = await resp.arrayBuffer();
            const font = new FontFace('OdiaFont', buf);
            await font.load(); document.fonts.add(font);
            window.assets.font = true;
            document.getElementById('fontStatus').className = 'status-badge status-ok';
            document.getElementById('fontStatus').textContent = 'Auto-Loaded';
        }
    } catch(e) {}

    try {
        const resp = await fetch('background.png');
        if(resp.ok) {
            const blob = await resp.blob();
            const img = new Image();
            img.src = URL.createObjectURL(blob);
            img.onload = () => {
                window.assets.template = img;
                window.assets.mode = 'auto';
                document.getElementById('tplStatus').className = 'status-badge status-ok';
                document.getElementById('tplStatus').textContent = 'Auto-Loaded';
                updateSelection();
            }
        }
    } catch(e) {}
    updateSelection();
}

/* ---------- FIREBASE ---------- */
try{
  const firebaseConfig = {
      apiKey: "AIzaSyC76wT0RbwuLGbhp0mU7kje25g-xxydLqU",
      authDomain: "idcard-60586.firebaseapp.com",
      projectId: "idcard-60586",
      storageBucket: "idcard-60586.firebasestorage.app",
      messagingSenderId: "331979663377",
      appId: "1:331979663377:web:026e537a7fcaca813129b0",
      measurementId: "G-PXVV87C78S"
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  loadData();
  loadAutoAssets();
} catch(e){ console.error(e); alert('Firebase error: '+e.message); }

/* ---------- DATA LOGIC ---------- */
function loadData(){
    const grid = document.getElementById('schoolGrid');
    grid.innerHTML = '<p>Loading data...</p>';
    db.collection('students').get().then(qs => {
        allStudents = []; schoolsMap = {};
        qs.forEach(doc => {
            const d = doc.data();
            allStudents.push(d);
            if(d.schoolName){
                if(!schoolsMap[d.schoolName]) {
                    schoolsMap[d.schoolName] = {
                        name: d.schoolName, count: 0,
                        block: d.block || '', district: d.district || '',
                        pin: d.pin || '', phone: d.hmPhone || d.mobile || '',
                        signature: d.hmSignature || ''
                    };
                }
                schoolsMap[d.schoolName].count++;
                const sm = schoolsMap[d.schoolName];
                if(!sm.signature && d.hmSignature) sm.signature = d.hmSignature;
                if(!sm.block && d.block) sm.block = d.block;
            }
        });
        renderDashboard();
    });
}

function renderDashboard(){
    const grid = document.getElementById('schoolGrid');
    grid.innerHTML = '';
    const names = Object.keys(schoolsMap).sort();
    if(names.length === 0){ grid.innerHTML = '<p>No schools found.</p>'; return; }
    names.forEach(name => {
        const s = schoolsMap[name];
        const div = document.createElement('div');
        div.className = 'school-card';
        div.onclick = () => openSchoolDetail(name);
        div.innerHTML = `<h3>${escapeHtml(s.name)}</h3><div class="school-meta">üìç ${escapeHtml(s.district)}</div><div class="school-meta">üë• ${s.count} Students</div>`;
        grid.appendChild(div);
    });
}

function showDashboard(){
    document.getElementById('detailView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
}

function openSchoolDetail(name){
    const s = schoolsMap[name];
    currentSchoolStudents = allStudents.filter(x => x.schoolName === name);
    document.getElementById('viewSchoolName').textContent = s.name;
    document.getElementById('viewAddress').textContent = `${s.block}, ${s.district} - ${s.pin}`;
    document.getElementById('viewContact').textContent = `üìû ${s.phone}`;
    const sign = document.getElementById('viewHmSign');
    if(s.signature) { sign.src = s.signature; sign.style.display='block'; } 
    else { sign.style.display='none'; }
    
    renderTable();
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('detailView').classList.remove('hidden');
    updateSelection();
}

function renderTable(){
    const tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = '';
    document.getElementById('selectAll').checked = false;
    currentSchoolStudents.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="checkbox" class="sel" value="${s.id}"></td><td>${i+1}</td>
        <td><img class="thumb" src="${s.photoBase64 || ''}"></td>
        <td>${s.name}</td><td>${s.class}</td><td>${s.roll}</td><td>${s.dob}</td><td>${s.bloodGroup||''}</td><td>${s.mobile||''}</td>
        <td><button class="btn btn-primary" onclick="openEditModal('${s.id}')">‚úé</button> <button class="btn btn-danger" onclick="del('${s.id}')">üóë</button></td>`;
        tbody.appendChild(tr);
    });
    document.querySelectorAll('.sel').forEach(c => c.onchange = updateSelection);
}

document.getElementById('selectAll').onchange = e => {
    document.querySelectorAll('.sel').forEach(c => c.checked = e.target.checked);
    updateSelection();
};

function updateSelection(){
    const n = document.querySelectorAll('.sel:checked').length;
    document.getElementById('selectionCount').textContent = `${n} selected`;
    const btn = document.getElementById('generateBtn');
    
    if(n > 0 && window.assets.font && window.assets.template) {
        btn.disabled = false;
        btn.innerHTML = `üñ® Generate <b>${n}</b> Cards`;
    } else {
        btn.disabled = true;
    }
}

/* ---------- MANUAL UPLOAD ---------- */
document.getElementById('fontInput').onchange = async e => {
    const f = e.target.files[0]; if(!f) return;
    const buf = await f.arrayBuffer();
    const font = new FontFace('OdiaFont', buf);
    await font.load(); document.fonts.add(font);
    window.assets.font = true;
    document.getElementById('fontStatus').className = 'status-badge status-ok';
    document.getElementById('fontStatus').textContent = 'Manual Load';
    updateSelection();
};
document.getElementById('templateInput').onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const img = new Image(); img.src = URL.createObjectURL(f);
    img.onload = () => {
        window.assets.template = img;
        window.assets.mode = 'manual'; // SWITCH TO MANUAL
        document.getElementById('tplStatus').className = 'status-badge status-ok';
        document.getElementById('tplStatus').textContent = 'Manual Load';
        updateSelection();
    }
};

/* ---------- ROBUST AI LOADER ---------- */
let FaceDetector = null, FilesetResolver = null, faceDetector = null;
async function importVision(url){ try{ return await import(url); }catch(e){ console.warn('vision import fail', url, e); throw e; } }
async function loadVisionBundle(){
  const candidates = [
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs",
    "https://unpkg.com/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs"
  ];
  for(const c of candidates){ try{ const mod = await importVision(c); return mod; } catch(e){ } }
  throw new Error('vision bundle failed');
}
async function initializeFaceDetector(){
  window.assets.aiModel = 'pending'; updateSelection();
  try{
    const mod = await loadVisionBundle(); 
    FaceDetector = mod.FaceDetector; FilesetResolver = mod.FilesetResolver;
    const wasmCandidates = ["https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm","https://unpkg.com/@mediapipe/tasks-vision@0.10.14/wasm"];
    let fileset = null;
    for(const w of wasmCandidates){ try{ fileset = await FilesetResolver.forVisionTasks(w); break; }catch(e){ } }
    if(!fileset) throw new Error('FilesetResolver failed');
    faceDetector = await FaceDetector.createFromOptions(fileset, { baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/1/blaze_face_short_range.tflite", delegate:"GPU" }, minDetectionConfidence:0.5, runningMode:"IMAGE" });
    window.assets.aiModel = 'loaded'; document.getElementById('aiStatus').textContent = "‚úÖ AI Ready";
  }catch(err){ 
    window.assets.aiModel = 'failed'; 
    document.getElementById('aiStatus').textContent = "‚ö†Ô∏è AI Failed (Simple Crop)";
  }
  updateSelection();
}
initializeFaceDetector();

/* ---------- HELPER: REMOVE WHITE BG ---------- */
function makeWhiteTransparent(img) {
    const c = document.createElement('canvas');
    c.width = img.width; c.height = img.height;
    const cx = c.getContext('2d');
    cx.drawImage(img, 0, 0);
    const imgData = cx.getImageData(0,0, c.width, c.height);
    const data = imgData.data;
    for(let i=0; i<data.length; i+=4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        if(r > 200 && g > 200 && b > 200) {
            data[i+3] = 0; // Transparent
        }
    }
    cx.putImageData(imgData, 0, 0);
    return c;
}

/* ---------- DRAWING ENGINE ---------- */
const canvas = document.getElementById('cardCanvas');
const ctx = canvas.getContext('2d');

async function drawCard(s) {
    canvas.width = CARD_W; canvas.height = CARD_H;
    ctx.clearRect(0,0,CARD_W,CARD_H);

    // 1. Background
    ctx.drawImage(window.assets.template, 0, 0, CARD_W, CARD_H);

    // 2. School Details & Signature (ONLY IF AUTO MODE)
    if(window.assets.mode === 'auto') {
        const sm = schoolsMap[s.schoolName];
        
        // School Name: Auto-scale to fit between 119px and 611px (Width = 492px)
        const MAX_W = HEADER_MAX_X - HEADER_MIN_X;
        ctx.fillStyle = '#FFFFFF'; 
        ctx.textAlign = 'center'; 
        let fontSize = 45; // Starting Size
        ctx.font = `bold ${fontSize}px OdiaFont`;
        
        // Loop to shrink font if text is too wide
        while (ctx.measureText(s.schoolName).width > MAX_W && fontSize > 10) {
            fontSize--;
            ctx.font = `bold ${fontSize}px OdiaFont`;
        }
        ctx.fillText(s.schoolName, HEADER_CENTER_X, HEADER_Y);
        
        // Address (Block, District, Pin) at 198, 94
        ctx.textAlign = 'left';
        ctx.font = '32px OdiaFont'; 
        const addrText = `${sm.block}, ${sm.district} - ${toOdiaDigits(sm.pin)}`;
        ctx.fillText(addrText, ADDR_X, ADDR_Y);

        // Signature at 434, 881 (with BG removal)
        if(sm && sm.signature) {
            const signImg = new Image(); signImg.src = sm.signature;
            await new Promise(r => signImg.onload=r);
            const cleanSign = makeWhiteTransparent(signImg);
            
            // Aspect ratio scaling
            const ratio = Math.min(SIGN_MAX_W / cleanSign.width, SIGN_MAX_H / cleanSign.height);
            const sw = cleanSign.width * ratio;
            const sh = cleanSign.height * ratio;
            
            ctx.drawImage(cleanSign, SIGN_X, SIGN_Y, sw, sh);
        }
    }

    // 3. Photo & Box (Standard Coordinates)
    const tplW = window.assets.template.width || CARD_W;
    const scale = CARD_W / tplW;
    const ORIG_PX = 222, ORIG_PY = 250, ORIG_PW = 187, ORIG_PH = 225;
    const px = Math.round(ORIG_PX * scale), py = Math.round(ORIG_PY * scale);
    const pw = Math.round(ORIG_PW * scale), ph = Math.round(ORIG_PH * scale);
    const border = Math.max(2, Math.round(3 * scale));

    ctx.fillStyle = '#000'; ctx.fillRect(px - border, py - border, pw + border*2, ph + border*2);

    if(s.photoBase64) {
        const photo = new Image(); photo.src = s.photoBase64;
        await new Promise(r => photo.onload=r);
        let sx=0, sy=0, sw=photo.width, sh=photo.height;
        
        if(window.assets.aiModel === 'loaded' && faceDetector) {
            try {
                const det = faceDetector.detect(photo);
                if(det && det.detections && det.detections.length > 0) {
                    const bbox = det.detections[0].boundingBox;
                    const add_w = parseInt(bbox.width * 0.6); 
                    const add_h = parseInt(bbox.height * 1.4); 
                    sx = Math.max(0, bbox.originX - add_w/2);
                    sy = Math.max(0, bbox.originY - add_h/2);
                    sw = Math.min(photo.width - sx, bbox.width + add_w);
                    sh = Math.min(photo.height - sy, bbox.height + add_h);
                }
            } catch(e){}
        }
        ctx.drawImage(photo, sx, sy, sw, sh, px, py, pw, ph);
    }

    // 4. Student Text
    ctx.fillStyle = '#000'; ctx.textBaseline = 'alphabetic'; ctx.textAlign = 'left';
    ctx.font = `${Math.round(38*scale)}px OdiaFont`;
    const tx = Math.round(227*scale);
    let dob = s.dob || '';
    try{ const [y,m,d] = dob.split('-'); if(y&&m&&d) dob = `${d}/${m}/${y}`; } catch(e){}
    
    ctx.fillText(s.name||'', tx, Math.round((505+38)*scale));
    ctx.fillText(s.class||'', tx, Math.round((575+38)*scale));
    ctx.fillText(toOdiaDigits(dob), tx, Math.round((647+38)*scale));
    ctx.fillText(toOdiaDigits(s.roll), tx, Math.round((718+38)*scale));
    const phNum = s.mobile || s.phone || '';
    ctx.fillText(toOdiaDigits(phNum), tx, Math.round((789+38)*scale));
    
    if(s.bloodGroup){
        ctx.fillStyle = 'white'; ctx.font = `${Math.round(23*scale)}px OdiaFont`;
        ctx.fillText(s.bloodGroup, Math.round(480*scale), Math.round((360+23)*scale));
    }

    return await new Promise(r => canvas.toBlob(r, 'image/png'));
}

/* ---------- GENERATE HANDLER ---------- */
document.getElementById('generateBtn').onclick = async () => {
    const ids = Array.from(document.querySelectorAll('.sel:checked')).map(c => c.value);
    const targets = currentSchoolStudents.filter(s => ids.includes(s.id.toString()));
    const btn = document.getElementById('generateBtn');
    btn.disabled = true; btn.textContent = "Processing...";

    const zip = new JSZip();
    const folder = zip.folder("PNGs");
    const { jsPDF } = window.jspdf;
    
    const verifyPdf = new jsPDF({ unit:'px', format:[CARD_W, CARD_H] });
    const printPdf = new jsPDF({ unit:'px', format:[CARD_W, CARD_H] });

    const imgs = [];

    for(let i=0; i<targets.length; i++) {
        btn.textContent = `Drawing ${i+1}/${targets.length}...`;
        const blob = await drawCard(targets[i]);
        folder.file(`${targets[i].name}_${targets[i].roll}.png`, blob);
        
        const imgUrl = URL.createObjectURL(blob);
        const imgObj = new Image(); imgObj.src = imgUrl;
        await new Promise(r => imgObj.onload=r);
        imgs.push(imgObj);

        if(i>0) printPdf.addPage([CARD_W, CARD_H], 'portrait');
        printPdf.addImage(imgObj, 'PNG', 0, 0, CARD_W, CARD_H);

        if(i>0) verifyPdf.addPage([CARD_W, CARD_H], 'portrait');
        verifyPdf.addImage(imgObj, 'PNG', 0, 0, CARD_W, CARD_H);
        
        verifyPdf.saveGraphicsState();
        verifyPdf.setGState(new verifyPdf.GState({opacity: 0.3}));
        verifyPdf.setTextColor(255, 0, 0); 
        verifyPdf.setFontSize(30);
        for(let r=-50; r<CARD_H+50; r+=150) {
            for(let c=-50; c<CARD_W+50; c+=200) {
                verifyPdf.text("VERIFICATION ONLY", c, r, {angle:45});
            }
        }
        verifyPdf.restoreGraphicsState();
    }

    btn.textContent = "Building A4 Sheets...";
    const pageCvs = document.createElement('canvas'); pageCvs.width=A4_W; pageCvs.height=A4_H;
    const pctx = pageCvs.getContext('2d');
    const GAP_X = 40, GAP_Y = 150;
    const startX = (A4_W - ((5*CARD_W)+(4*GAP_X)))/2;
    const startY = (A4_H - ((2*CARD_H)+(1*GAP_Y)))/2;

    for(let i=0; i<imgs.length; i+=10) {
        pctx.fillStyle='#fff'; pctx.fillRect(0,0,A4_W,A4_H);
        const chunk = imgs.slice(i, i+10);
        chunk.forEach((img, idx) => {
            const c = idx % 5; const r = Math.floor(idx/5);
            const x = startX + c*(CARD_W+GAP_X);
            const y = startY + r*(CARD_H+GAP_Y);
            pctx.drawImage(img, x, y);
            pctx.strokeStyle='#ccc'; pctx.lineWidth=2; pctx.strokeRect(x,y,CARD_W,CARD_H);
        });
        const pBlob = await new Promise(r => pageCvs.toBlob(r, 'image/jpeg', 0.9));
        zip.file(`A4_Print_Sheet_${Math.floor(i/10)+1}.jpg`, pBlob);
    }

    zip.file("Verify_Proof.pdf", verifyPdf.output('arraybuffer'));
    
    btn.textContent = "Zipping...";
    const content = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(content);
    a.download = `ID_Cards_${Date.now()}.zip`; a.click();
    
    btn.disabled = false; updateSelection();
};

/* ---------- EDIT/DEL (FIXED) ---------- */
function openEditModal(id){
    const s = currentSchoolStudents.find(x => x.id == id);
    if(!s) { console.error('Student not found:', id); return; }
    document.getElementById('editId').value = s.id;
    document.getElementById('editName').value = s.name;
    document.getElementById('editClass').value = s.class;
    document.getElementById('editRoll').value = s.roll;
    document.getElementById('editDob').value = s.dob;
    document.getElementById('editBlood').value = s.bloodGroup;
    document.getElementById('editPhone').value = s.mobile || s.phone || '';
    document.getElementById('editModal').style.display = 'flex';
}

function del(id){
    if(!confirm('Delete?')) return;
    db.collection('students').doc(id.toString()).delete().then(loadData);
}

document.getElementById('saveEditBtn').onclick = async () => {
    const id = document.getElementById('editId').value;
    const data = {
        name: document.getElementById('editName').value,
        class: document.getElementById('editClass').value,
        roll: document.getElementById('editRoll').value,
        dob: document.getElementById('editDob').value,
        bloodGroup: document.getElementById('editBlood').value,
        mobile: document.getElementById('editPhone').value
    };
    try {
        await db.collection('students').doc(id.toString()).update(data);
        const s = currentSchoolStudents.find(x => x.id == id);
        if(s) Object.assign(s, data);
        document.getElementById('editModal').style.display='none';
        renderTable();
    } catch(e) { alert("Error: "+e.message); }
};
</script>
</body>
</html>
