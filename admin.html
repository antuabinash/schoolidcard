<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - ID Cards Pro</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding:20px; background:#f4f7f6; color:#222; }
    .container { max-width:1200px; margin:0 auto; }
    h1 { color:#0b53a0; margin-bottom: 20px; }
    
    /* Utility */
    .hidden { display: none !important; }
    .btn { padding:10px 15px; border-radius:6px; border:none; cursor:pointer; font-weight:600; color:white; }
    .btn-primary { background:#007bff; }
    .btn-success { background:#28a745; }
    .btn-danger { background:#dc3545; }
    .btn-warning { background:#ffc107; color:#222; }
    .btn-secondary { background:#6c757d; }
    input, select { padding:10px; border-radius:6px; border:1px solid #ccc; }

    /* VIEW 1: School Grid */
    .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .school-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; border: 1px solid #eee; }
    .school-card:hover { transform: translateY(-3px); border-color: #007bff; }
    .school-card h3 { margin: 0 0 10px 0; color: #0b53a0; }
    .school-meta { font-size: 13px; color: #666; margin-bottom: 5px; }

    /* VIEW 2: School Detail */
    .detail-header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: start; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .school-info h2 { margin: 0 0 5px 0; color: #0b53a0; }
    .school-address { color: #555; font-size: 14px; }
    .hm-section { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
    .hm-sign-img { height: 50px; border: 1px solid #ddd; margin-top: 5px; background: white; padding: 2px; }

    /* Configuration Panel (Inputs) */
    .config-panel { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #90caf9; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    
    /* Table */
    .table-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
    table { width:100%; border-collapse:collapse; font-size: 14px; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align: middle; }
    th { background:#f8f9fa; color:#333; font-weight: 600; }
    img.thumb { width:35px; height:35px; border-radius:4px; object-fit: cover; border: 1px solid #ddd; }

    /* Bottom Action Bar */
    .action-bar { margin-top: 20px; padding: 20px; background: white; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); position: sticky; bottom: 0; }
    .status-text { font-style: italic; color: #666; }

    /* Modals */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; }
    .modal-content { background:white; padding:25px; border-radius:8px; width:90%; max-width:400px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
    .form-group input, .form-group select { width: 100%; box-sizing: border-box; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

    @media(max-width:768px) {
        .detail-header { flex-direction: column; gap: 15px; }
        .hm-section { align-items: flex-start; text-align: left; }
        .action-bar { flex-direction: column; gap: 10px; }
        .btn { width: 100%; }
    }
  </style>
</head>
<body>

<div class="container">

  <div id="dashboardView">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1>Admin Dashboard</h1>
        <div>
            <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh Data</button>
            <button class="btn btn-warning" id="downloadRawBtn">üíæ Backup All Data</button>
        </div>
    </div>
    <div id="schoolGrid" class="school-grid">
        <p>Loading schools...</p>
    </div>
  </div>

  <div id="detailView" class="hidden">
    <button class="btn btn-secondary" onclick="showDashboard()" style="margin-bottom:15px;">‚Üê Back to Schools</button>
    
    <div class="detail-header">
        <div class="school-info">
            <h2 id="viewSchoolName">School Name</h2>
            <div class="school-address">
                <span id="viewBlock"></span> <span id="viewDistrict"></span> <span id="viewPin"></span>
            </div>
            <div style="margin-top:5px; color:#0277bd; font-weight:bold;" id="viewContact"></div>
        </div>
        <div class="hm-section">
            <small>Headmaster Signature</small>
            <img id="viewHmSign" class="hm-sign-img" src="" alt="No Sign">
            <a id="downloadSignBtn" href="#" download style="font-size:11px; margin-top:2px;">Download Sign</a>
        </div>
    </div>

    <div class="config-panel">
        <div>
            <label style="font-size:12px; font-weight:bold;">1. ID Card Template (.png)</label><br>
            <input id="templateInput" type="file" accept="image/png">
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">2. Odia Font (.ttf)</label><br>
            <input id="fontInput" type="file" accept=".ttf,.otf">
        </div>
        <div style="flex:1; text-align:right;">
             <span id="generatorStatus" class="status-text">Status: ‚ùå Template, ‚ùå Font, ‚è≥ AI...</span>
        </div>
    </div>

    <div class="table-container">
        <table id="studentTable">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" id="selectAll"></th>
                    <th>#</th>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Roll</th>
                    <th>DOB</th>
                    <th>Blood</th>
                    <th>Phone</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="action-bar">
        <div>
            <span id="selectionCount">0 students selected</span>
        </div>
        <button id="generateBtn" class="btn btn-success" disabled style="font-size:16px; padding: 12px 24px;">
            üñ® Generate ID Cards
        </button>
    </div>

  </div>
</div>

<canvas id="cardCanvas" style="display:none;"></canvas>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Edit Student</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>Class</label><input type="text" id="editClass"></div>
            <div class="form-group"><label>Roll</label><input type="text" id="editRoll"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="form-group"><label>DOB</label><input type="date" id="editDob"></div>
            <div class="form-group"><label>Blood</label><select id="editBlood">
                <option value="">-</option><option value="A+">A+</option><option value="B+">B+</option>
                <option value="O+">O+</option><option value="AB+">AB+</option>
            </select></div>
        </div>
        <div class="form-group"><label>Mobile</label><input type="text" id="editPhone"></div>
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
            <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
        </div>
    </div>
</div>

<script>
/* ---------- Constants ---------- */
const DPI = 300;
const CARD_MM_W = 54.0, CARD_MM_H = 85.6; 
const CARD_W = Math.round((CARD_MM_W / 25.4) * DPI);
const CARD_H = Math.round((CARD_MM_H / 25.4) * DPI);
const A4_W = 3508, A4_H = 2480;

/* ---------- Helpers ---------- */
window.odiaDigits = ['‡≠¶','‡≠ß','‡≠®','‡≠©','‡≠™','‡≠´','‡≠¨','‡≠≠','‡≠Æ','‡≠Ø'];
function toOdiaDigits(str){ if (str===undefined||str===null) return ''; return (''+str).replace(/\d/g,d=>window.odiaDigits[d]||d); }
function escapeHtml(s){ return (s+'').replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

/* ---------- State ---------- */
let db = null;
let allStudents = [];
let schoolsMap = {}; // Object to group data
let currentSchoolStudents = [];
window.assets = { template:null, font:null, aiModel:'pending' };

/* ---------- Firebase Init ---------- */
try{
  const firebaseConfig = {
      apiKey: "AIzaSyC76wT0RbwuLGbhp0mU7kje25g-xxydLqU",
      authDomain: "idcard-60586.firebaseapp.com",
      projectId: "idcard-60586",
      storageBucket: "idcard-60586.firebasestorage.app",
      messagingSenderId: "331979663377",
      appId: "1:331979663377:web:026e537a7fcaca813129b0",
      measurementId: "G-PXVV87C78S"
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  loadData();
} catch(e){ console.error(e); alert('Firebase error: '+e.message); }

/* ---------- Data Loading Logic ---------- */
function loadData(){
    const grid = document.getElementById('schoolGrid');
    grid.innerHTML = '<p>Loading data...</p>';
    
    db.collection('students').get().then(qs => {
        allStudents = [];
        schoolsMap = {};

        qs.forEach(doc => {
            const d = doc.data();
            allStudents.push(d);
            
            // Extract school metadata from students
            if(d.schoolName){
                if(!schoolsMap[d.schoolName]) {
                    schoolsMap[d.schoolName] = {
                        name: d.schoolName,
                        count: 0,
                        // Capture metadata from first student found for this school
                        block: d.block || '',
                        district: d.district || '',
                        pin: d.pin || '',
                        phone: d.hmPhone || d.mobile || '', // Fallback to student mobile if no HM phone
                        signature: d.hmSignature || ''
                    };
                }
                schoolsMap[d.schoolName].count++;
                
                // Update metadata if found in later records (in case first record was empty)
                const sm = schoolsMap[d.schoolName];
                if(!sm.signature && d.hmSignature) sm.signature = d.hmSignature;
                if(!sm.block && d.block) sm.block = d.block;
            }
        });

        renderDashboard();
    }).catch(err => {
        grid.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
    });
}

function renderDashboard(){
    const grid = document.getElementById('schoolGrid');
    grid.innerHTML = '';
    
    const schoolNames = Object.keys(schoolsMap).sort();
    
    if(schoolNames.length === 0){
        grid.innerHTML = '<p>No schools found.</p>';
        return;
    }

    schoolNames.forEach(name => {
        const s = schoolsMap[name];
        const div = document.createElement('div');
        div.className = 'school-card';
        div.onclick = () => openSchoolDetail(name);
        div.innerHTML = `
            <h3>${escapeHtml(s.name)}</h3>
            <div class="school-meta">üìç ${escapeHtml(s.district||'Unknown District')}</div>
            <div class="school-meta">üë• ${s.count} Students</div>
            <div class="school-meta">üìû ${escapeHtml(s.phone||'N/A')}</div>
        `;
        grid.appendChild(div);
    });
}

/* ---------- Navigation ---------- */
function showDashboard(){
    document.getElementById('detailView').classList.add('hidden');
    document.getElementById('dashboardView').classList.remove('hidden');
    window.scrollTo(0,0);
}

function openSchoolDetail(schoolName){
    const sData = schoolsMap[schoolName];
    currentSchoolStudents = allStudents.filter(s => s.schoolName === schoolName);
    
    // Populate Header
    document.getElementById('viewSchoolName').textContent = sData.name;
    document.getElementById('viewBlock').textContent = sData.block ? `Block: ${sData.block},` : '';
    document.getElementById('viewDistrict').textContent = sData.district ? `Dist: ${sData.district}` : '';
    document.getElementById('viewPin').textContent = sData.pin ? `-${sData.pin}` : '';
    document.getElementById('viewContact').textContent = sData.phone ? `üìû Contact: ${sData.phone}` : '';
    
    const signImg = document.getElementById('viewHmSign');
    const dlBtn = document.getElementById('downloadSignBtn');
    
    if(sData.signature){
        signImg.src = sData.signature;
        signImg.style.display = 'block';
        dlBtn.href = sData.signature;
        dlBtn.style.display = 'inline-block';
    } else {
        signImg.style.display = 'none';
        dlBtn.style.display = 'none';
    }

    // Render Table
    renderStudentTable();
    
    // Switch View
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('detailView').classList.remove('hidden');
    window.scrollTo(0,0);
    updateStatus();
}

/* ---------- Table Logic ---------- */
function renderStudentTable(){
    const tbody = document.querySelector('#studentTable tbody');
    tbody.innerHTML = '';
    document.getElementById('selectAll').checked = false;

    currentSchoolStudents.forEach((s, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" class="student-select" value="${s.id}"></td>
            <td>${idx+1}</td>
            <td><img class="thumb" src="${s.photoBase64 || 'https://placehold.co/40'}" onclick="window.open(this.src)"></td>
            <td>${escapeHtml(s.name)}</td>
            <td>${escapeHtml(s.class)}</td>
            <td>${escapeHtml(s.roll)}</td>
            <td>${escapeHtml(s.dob)}</td>
            <td>${escapeHtml(s.bloodGroup)}</td>
            <td>${escapeHtml(s.mobile || s.phone || '')}</td>
            <td>
                <button class="btn btn-primary" style="padding:4px 8px; font-size:12px;" onclick="editStudent('${s.id}')">‚úé</button>
                <button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteStudent('${s.id}')">üóë</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Listeners
    document.querySelectorAll('.student-select').forEach(cb => cb.addEventListener('change', updateSelection));
}

document.getElementById('selectAll').onchange = (e) => {
    document.querySelectorAll('.student-select').forEach(cb => cb.checked = e.target.checked);
    updateSelection();
};

function updateSelection(){
    const count = document.querySelectorAll('.student-select:checked').length;
    document.getElementById('selectionCount').textContent = `${count} students selected`;
    
    const btn = document.getElementById('generateBtn');
    if(count > 0 && window.assets.template && window.assets.font && window.assets.aiModel !== 'pending'){
        btn.disabled = false;
        btn.textContent = `üñ® Generate ${count} ID Cards`;
    } else {
        btn.disabled = true;
        if(!window.assets.template) btn.textContent = "Upload Template First";
        else if(!window.assets.font) btn.textContent = "Upload Font First";
        else if(count === 0) btn.textContent = "Select Students First";
    }
}

/* ---------- AI & Generator Setup (Same as before) ---------- */
let FaceDetector=null, FilesetResolver=null, faceDetector=null;
async function initializeFaceDetector(){
  window.assets.aiModel = 'pending'; updateStatus();
  try{
    const mod = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs");
    FaceDetector = mod.FaceDetector; FilesetResolver = mod.FilesetResolver;
    const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
    faceDetector = await FaceDetector.createFromOptions(fileset, { baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_detector/blaze_face_short_range/float16/1/blaze_face_short_range.tflite", delegate:"GPU" }, minDetectionConfidence:0.5, runningMode:"IMAGE" });
    window.assets.aiModel = 'loaded'; updateStatus();
  }catch(err){ window.assets.aiModel = 'failed'; updateStatus(); }
}
initializeFaceDetector();

function updateStatus(){ 
    const t = window.assets.template ? '‚úÖ Template' : '‚ùå Template'; 
    const f = window.assets.font ? '‚úÖ Font' : '‚ùå Font'; 
    const ai = window.assets.aiModel === 'loaded' ? '‚úÖ AI' : '‚è≥ AI...';
    document.getElementById('generatorStatus').textContent = `Status: ${t}, ${f}, ${ai}`; 
    updateSelection();
}

document.getElementById('templateInput').onchange = e => {
    const f=e.target.files[0]; if(!f) return;
    const img=new Image(); img.src=URL.createObjectURL(f);
    img.onload=()=>{ window.assets.template=img; updateStatus(); }
}
document.getElementById('fontInput').onchange = async e => {
    const f=e.target.files[0]; if(!f) return;
    const buf=await f.arrayBuffer();
    window.assets.font = new FontFace('OdiaFont', buf);
    document.fonts.add(window.assets.font); await window.assets.font.load();
    updateStatus();
}

/* ---------- Generator Logic ---------- */
const cardCanvas = document.getElementById('cardCanvas');
const ctx = cardCanvas.getContext('2d');

async function generateCardImage(student){
  cardCanvas.width = CARD_W; cardCanvas.height = CARD_H;
  ctx.clearRect(0,0,CARD_W,CARD_H);
  
  if(window.assets.template) ctx.drawImage(window.assets.template, 0, 0, CARD_W, CARD_H);
  else { ctx.fillStyle='white'; ctx.fillRect(0,0,CARD_W,CARD_H); }
  
  // Coordinates based on previous context
  const ORIG_PX = 222, ORIG_PY = 250, ORIG_PW = 187, ORIG_PH = 225;
  const tplW = window.assets.template.width || CARD_W;
  const scale = CARD_W / tplW;
  
  const px = Math.round(ORIG_PX * scale), py = Math.round(ORIG_PY * scale);
  const pw = Math.round(ORIG_PW * scale), ph = Math.round(ORIG_PH * scale);
  const border = Math.max(2, Math.round(3 * scale));

  // Black BG for photo
  ctx.fillStyle = '#000'; ctx.fillRect(px - border, py - border, pw + border*2, ph + border*2);

  const photo = new Image(); photo.crossOrigin = "Anonymous";
  if(student.photoBase64){
      photo.src = student.photoBase64;
      await new Promise(r => { photo.onload=r; photo.onerror=r; });
  }

  // AI Face Crop
  let sx=0, sy=0, sW=photo.width||1, sH=photo.height||1;
  if(photo.width && faceDetector && window.assets.aiModel === 'loaded'){
      try {
          const det = faceDetector.detect(photo);
          if(det && det.detections && det.detections.length>0){
              const bbox = det.detections[0].boundingBox;
              const add_w = parseInt(bbox.width * 0.6); 
              const add_h = parseInt(bbox.height * 1.4); 
              sx = Math.max(0, bbox.originX - add_w/2);
              sy = Math.max(0, bbox.originY - add_h/2);
              sW = Math.min(photo.width - sx, bbox.width + add_w);
              sH = Math.min(photo.height - sy, bbox.height + add_h);
          }
      } catch(e){}
  }
  
  if(photo.width) ctx.drawImage(photo, sx, sy, sW, sH, px, py, pw, ph);
  
  // Text Drawing
  ctx.fillStyle = '#000'; ctx.textBaseline = 'alphabetic';
  ctx.font = `${Math.round(38*scale)}px OdiaFont`;
  const tx = Math.round(227*scale);
  
  let dob = student.dob || '';
  try{ const [y,m,d] = dob.split('-'); if(y&&m&&d) dob = `${d}/${m}/${y}`; } catch(e){}
  
  ctx.fillText(student.name||'', tx, Math.round((505+38)*scale));
  ctx.fillText(student.class||'', tx, Math.round((575+38)*scale));
  ctx.fillText(toOdiaDigits(dob), tx, Math.round((647+38)*scale));
  ctx.fillText(toOdiaDigits(student.roll), tx, Math.round((718+38)*scale));
  const phNum = student.mobile || student.phone || '';
  ctx.fillText(toOdiaDigits(phNum), tx, Math.round((789+38)*scale));
  
  if(student.bloodGroup){
      ctx.fillStyle = 'white'; ctx.font = `${Math.round(23*scale)}px OdiaFont`;
      ctx.fillText(student.bloodGroup, Math.round(480*scale), Math.round((360+23)*scale));
  }
  return await new Promise(r => cardCanvas.toBlob(r, 'image/png'));
}

document.getElementById('generateBtn').onclick = async () => {
    const checkboxes = document.querySelectorAll('.student-select:checked');
    if(checkboxes.length === 0) return;
    
    const btn = document.getElementById('generateBtn');
    btn.disabled = true; btn.textContent = "Processing...";
    
    try {
        const selectedIds = Array.from(checkboxes).map(c => c.value);
        const dataToGen = currentSchoolStudents.filter(s => selectedIds.includes(s.id.toString()));
        
        const zip = new JSZip();
        const singleFolder = zip.folder('cards_png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit:'px', format:[CARD_W, CARD_H] });
        
        let singleImages = [];
        
        for(let i=0; i<dataToGen.length; i++){
            btn.textContent = `Generating ${i+1}/${dataToGen.length}...`;
            const blob = await generateCardImage(dataToGen[i]);
            const img = new Image(); img.src = URL.createObjectURL(blob);
            await new Promise(r => img.onload=r);
            
            singleFolder.file(`${dataToGen[i].name}_${dataToGen[i].roll}.png`, blob);
            
            if(i > 0) pdf.addPage([CARD_W, CARD_H], 'portrait');
            pdf.addImage(img, 'PNG', 0, 0, CARD_W, CARD_H);
            singleImages.push(img);
        }
        
        btn.textContent = "Creating A4 Sheets...";
        // A4 Layout logic (5x2 grid centered)
        const pageCanvas = document.createElement('canvas'); pageCanvas.width=A4_W; pageCanvas.height=A4_H;
        const pctx = pageCanvas.getContext('2d');
        const GAP_X = 40, GAP_Y = 150;
        const totalGridW = (5 * CARD_W) + (4 * GAP_X);
        const totalGridH = (2 * CARD_H) + (1 * GAP_Y);
        const startX = (A4_W - totalGridW) / 2;
        const startY = (A4_H - totalGridH) / 2;

        for(let i=0; i<singleImages.length; i+=10){
            pctx.fillStyle='white'; pctx.fillRect(0,0,A4_W,A4_H);
            const chunk = singleImages.slice(i, i+10);
            chunk.forEach((img, idx) => {
                const col = idx % 5; const row = Math.floor(idx / 5);
                const x = startX + col * (CARD_W + GAP_X);
                const y = startY + row * (CARD_H + GAP_Y);
                pctx.drawImage(img, x, y);
                pctx.strokeStyle='#ccc'; pctx.lineWidth=2; pctx.strokeRect(x,y,CARD_W,CARD_H);
            });
            const pBlob = await new Promise(r => pageCanvas.toBlob(r, 'image/jpeg', 0.9));
            zip.file(`Print_Sheet_${Math.floor(i/10)+1}.jpg`, pBlob);
        }

        btn.textContent = "Downloading...";
        const content = await zip.generateAsync({type:'blob'});
        const link = document.createElement('a'); link.href = URL.createObjectURL(content);
        link.download = `${document.getElementById('viewSchoolName').textContent}_Cards.zip`; link.click();
        
    } catch(e){ alert("Error: "+e.message); }
    
    updateSelection(); // Reset Button Text
};

/* ---------- Backup ---------- */
document.getElementById('downloadRawBtn').onclick = async () => {
    const zip = new JSZip();
    const allData = allStudents.map(s => ({
        name: s.name, class: s.class, roll: s.roll, dob: s.dob, mobile: s.mobile,
        school: s.schoolName, block: s.block, district: s.district
    }));
    const ws = XLSX.utils.json_to_sheet(allData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Students");
    zip.file('Database.xlsx', XLSX.write(wb, {type:'array', bookType:'xlsx'}));
    const blob = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='Backup.zip'; a.click();
};

/* ---------- Edit/Delete ---------- */
function deleteStudent(id){
    if(!confirm("Delete this student permanently?")) return;
    db.collection('students').doc(id).delete().then(() => {
        allStudents = allStudents.filter(s => s.id !== id);
        currentSchoolStudents = currentSchoolStudents.filter(s => s.id !== id);
        renderStudentTable();
    });
}

function editStudent(id){
    const s = currentSchoolStudents.find(x => x.id === id);
    if(!s) return;
    document.getElementById('editId').value = s.id;
    document.getElementById('editName').value = s.name;
    document.getElementById('editClass').value = s.class;
    document.getElementById('editRoll').value = s.roll;
    document.getElementById('editDob').value = s.dob;
    document.getElementById('editBlood').value = s.bloodGroup;
    document.getElementById('editPhone').value = s.mobile || s.phone || '';
    document.getElementById('editModal').style.display = 'flex';
}

document.getElementById('saveEditBtn').onclick = async () => {
    const id = document.getElementById('editId').value;
    const update = {
        name: document.getElementById('editName').value,
        class: document.getElementById('editClass').value,
        roll: document.getElementById('editRoll').value,
        dob: document.getElementById('editDob').value,
        bloodGroup: document.getElementById('editBlood').value,
        mobile: document.getElementById('editPhone').value
    };
    
    await db.collection('students').doc(id).update(update);
    
    // Update local data
    const idx = allStudents.findIndex(x => x.id == id);
    if(idx !== -1) allStudents[idx] = { ...allStudents[idx], ...update };
    
    const idx2 = currentSchoolStudents.findIndex(x => x.id == id);
    if(idx2 !== -1) currentSchoolStudents[idx2] = { ...currentSchoolStudents[idx2], ...update };
    
    document.getElementById('editModal').style.display = 'none';
    renderStudentTable();
};
</script>
</body>
</html>
